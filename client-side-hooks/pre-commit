#!/bin/bash

# This script should be copied to .git/hooks/ in your local repo

echo "START PRE-COMMIT HOOK ---------------------------------"

LOCAL_DEPLOY_DIR="/Users/mturner/Sites/6Deg/RealInteractive/Corporate/ri-templates/deploy/"
echo "LOCAL_DEPLOY_DIR: $LOCAL_DEPLOY_DIR"
LOCAL_DUMP_FILE="ri_contest_templates.sql"
echo "LOCAL_DUMP_FILE: $LOCAL_DUMP_FILE"

# Staging Server
if [ `git rev-parse --abbrev-ref HEAD` == "staging" ]; then

    # Dump the local database
    mysqldump -u root -proot ri_contest_templates > $LOCAL_DEPLOY_DIR$LOCAL_DUMP_FILE
    echo "Dumped local database to deploy directory.";

fi

# Production Server
if [ `git rev-parse --abbrev-ref HEAD` == "production" ]; then

    # # This is only required for the initial production deployment. After that we do not want to overwrite the production database.
    # # Dump the local database
    # mysqldump -u root -proot ri_contest_templates > $LOCAL_DEPLOY_DIR$LOCAL_DUMP_FILE
    # echo "Dumped local database to deploy directory.";

    # Path variables
    REMOTE_IMAGES_DIR="httpdocs/library/images/"
    echo "REMOTE_IMAGES_DIR: $REMOTE_IMAGES_DIR"
    LOCAL_IMAGES_DIR="/Users/mturner/Sites/6Deg/RealInteractive/Corporate/ri-templates/deploy/public-html/library/images/"
    echo "LOCAL_IMAGES_DIR: $LOCAL_IMAGES_DIR"
    LOCAL_ASSETS_DIR="/Users/mturner/Sites/6Deg/RealInteractive/Corporate/ri-templates/assets/"
    echo "LOCAL_ASSETS_DIR: $LOCAL_ASSETS_DIR"

    # # Delete remote backups (.deployment/backups) older than 7 days
    # find "/Users/mturner/Sites/6Deg/RealInteractive/Corporate/ri-templates/assets/database/production-backup* -mtime +7 | xargs rm -Rf"
    # echo "Removed production database backups older than 7 days."

    # Make the local assets backup directory if it does not exist
    mkdir -p $LOCAL_ASSETS_DIR"database/production-backup/"
    echo "Created local production database backup directory if it did not already exist"

    # Backup remote database to local assets dir
    mysqldump -h ridevelopment.ca -u ridev_con_tpl -p'Pzsr8#60' ridevelopment_contest_templates > $LOCAL_ASSETS_DIR"database/production-backup/ridevelopment_contest_templates_$(date +%Y-%m-%d_%H-%M-%S).sql"
    echo "Dumped production database to local assets backup."

    # Backup remote user generated images to local /public-html/library/images
    rsync -avzhe ridevelopment@ridevelopment.ca:$REMOTE_IMAGES_DIR"user_generated/" $LOCAL_IMAGES_DIR"user_generated/"
    echo "Copied user gerated images from server."

fi

echo "FINISH PRE-COMMIT HOOK --------------------------------"
